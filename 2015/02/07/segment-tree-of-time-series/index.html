<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta name="keywords" content="hexo, autumn" />
    <title>
        FENICE
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/favicon.ico" />
     
<link rel="stylesheet" href="/css/style.css">


    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css" />
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
    <script src="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@2.0.0/dist/main.js"></script>

    <script>
        infiniteScroll()

        window.addEventListener('DOMContentLoaded', function () {
            const [
                mainTitle,
                mobileMenu,
                mobileMainTitle,
                mobileMenuBtn,
                ipadMenuBtn,
                aside,
                closeBtn,
            ] = getEle(
                '#main-title',
                '.mobile-menu',
                '.mobile-menu h3',
                '.mobile-menu button',
                '.ipad-menu',
                'aside',
                'aside .close',
            )
            const io = new IntersectionObserver(entries => {
                if (entries[0].intersectionRatio <= 0) {
                    mobileMainTitle.classList.remove('invisibile')
                } else {
                    mobileMainTitle.classList.add('invisibile')
                }
            })
            io.observe(mainTitle)

            clickToggleAside(mobileMenuBtn)
            clickToggleAside(ipadMenuBtn)
            clickToggleAside(closeBtn, false)

            const isMenuVisible = window.getComputedStyle(mobileMenu).display !== 'none'
            if (isMenuVisible) document.body.style.background = 'none'

            function getEle(...args) {
                return args.map(arg => document.querySelector(arg))
            }

            function clickToggleAside(btn, show = true) {
                btn.addEventListener('click', function () {
                    if (show) {
                        aside.style.display = 'block'
                    } else {
                        aside.style.display = 'none'
                    }
                })
            }
        })
    </script>
<meta name="generator" content="Hexo 5.0.0"></head>

<body style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
    <div class="container">
        <header class="header">
    <nav class="mobile-menu" style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
        <h3 class="invisibile">
            <a href="/" class="logo">
                FENICE
            </a>
        </h3>
        <button class="menu">menu</button>
    </nav>

    <button class="ipad-menu menu">menu</button>

    <h1 class="title" id="main-title">
        <a href="/" class="logo">
            FENICE
        </a>
    </h1>
    <h2 class="desc">
        Rock and opera fans
    </h2>

    <div class="links">
        <ul>
            
            <li>
                <a target="_blank" rel="noopener" href="https://github.com/fenicesun">
                    Github
                </a>
            </li>
            
            <li>
                <a target="_blank" rel="noopener" href="https://www.linkedin.com/">
                    LinkedIn
                </a>
            </li>
            
        </ul>
    </div>
</header>
        <main class="main">
            <article class="post">
    
    
    <h4 class="post-cat">
        <a href="/categories/algorithm/">
            algorithm
        </a>
    </h4>
    
    
    <h2 class="post-title">
        segment tree of time series
    </h2>
    <ul class="post-date">
        <li>
            2015-02-07
        </li>
        <li>
            Fenice Sun
        </li>
    </ul>
    <div class="post-content">
        <h3 id="日期序列线段树"><a href="#日期序列线段树" class="headerlink" title="日期序列线段树"></a>日期序列线段树</h3><blockquote>
<p>处理时间序列的区间可加性问题</p>
</blockquote>
<pre><code>&lt;?php

/**
 * Description: 时间序列线段树
 *
 */

define(&quot;INFINITE&quot;, pow(2, 64));

class TSSegTree &amp;#123;

    private $begin;
    private $end;
    private $segTree = array();
    private $delay_mark = array();

    public static $debug_count = 0;

    public function __construct($begin, $end, $init_arr=array()) &amp;#123;

        $this-&gt;begin = $begin;
        $this-&gt;end   = $end;
        $this-&gt;build(0, $this-&gt;begin, $this-&gt;end, $init_arr);
    &amp;#125;

    private function lchild($father) &amp;#123;
        return $father * 2 + 1;
    &amp;#125;

    private function rchild($father) &amp;#123;
        return $father * 2 + 2;
    &amp;#125;

    // 取两个日期的中间日期
    private function middate($begin, $end) &amp;#123;
        $interval = (strtotime($end)-strtotime($begin)) / 86400;
        $interval = intval($interval / 2);
        return $this-&gt;nextnday($begin, $interval);
    &amp;#125;

    private function nextnday($date, $n=1) &amp;#123;
        $operator = $n &gt;= 0? &#39;+&#39; : &#39;-&#39;;
        return date(&#39;Y-m-d&#39;, strtotime(&quot;&amp;#123;$date&amp;#125; &amp;#123;$operator&amp;#125;&amp;#123;$n&amp;#125; day&quot;));
    &amp;#125;

    // 更新当前节点值
    public function pushUp($root) &amp;#123;
        $lchild = $this-&gt;lchild($root);
        $rchild = $this-&gt;rchild($root);
        $this-&gt;segTree[$root] = min($this-&gt;segTree[$lchild], $this-&gt;segTree[$rchild]);
    &amp;#125;

    // 构建线段树
    public function build($root = 0, $begin, $end, $init_arr=array()) &amp;#123;

        $this-&gt;delay_mark[$root] = 0;
        if (strtotime($begin) == strtotime($end)) &amp;#123;
            $this-&gt;segTree[$root] = $init_arr[$begin];
        &amp;#125; else &amp;#123;
            $mid = $this-&gt;middate($begin, $end);
            $this-&gt;build($root * 2 + 1, $begin, $mid, $init_arr);
            $this-&gt;build($root * 2 + 2,  $this-&gt;nextnday($mid), $end, $init_arr);
            $this-&gt;pushUp($root);
        &amp;#125;
    &amp;#125;

    // 区间查询
    public function query($root, $nbegin, $nend, $qbegin, $qend) &amp;#123;

        if (strtotime($qbegin) &gt; strtotime($nend) ||
              strtotime($qend) &lt; strtotime($nbegin) ) &amp;#123;
                return INFINITE;
        &amp;#125;
        if (strtotime($qbegin) &lt;= strtotime($nbegin) &amp;&amp;
              strtotime($qend) &gt;= strtotime($nend) ) &amp;#123;
              return $this-&gt;segTree[$root];
        &amp;#125;
        $this-&gt;pushDown($root);
        $mid = $this-&gt;middate($nbegin, $nend);
        return min($this-&gt;query($this-&gt;lchild($root), $nbegin, $mid, $qbegin, $qend),
              $this-&gt;query($this-&gt;rchild($root), $this-&gt;nextnday($mid), $nend, $qbegin, $qend ));
    &amp;#125;

    // 单节点更新
    public function updateNode($root, $nbegin, $nend, $index, $val) &amp;#123;
        if (strtotime($nbegin) == strtotime($nend)) &amp;#123;
            if (strtotime($index) == strtotime($nbegin)) &amp;#123;
                $this-&gt;segTree[$root] += $val;
                // or other update method
            &amp;#125;
            return;
        &amp;#125;
        $mid = $this-&gt;middate($nbegin, $nend);
        if (strtotime($index) &lt;= strtotime($mid)) &amp;#123;
            $this-&gt;updateNode($this-&gt;lchild($root), $nbegin, $mid, $index, $val);
        &amp;#125; else &amp;#123;
            $this-&gt;updateNode($this-&gt;rchild($root), $this-&gt;nextnday($mid), $nend, $index, $val);
        &amp;#125;
        $this-&gt;pushUp($root);
        return;
    &amp;#125;

    // 向子节点更新标志域
    public function pushDown($root) &amp;#123;
        if ($this-&gt;delay_mark[$root] != 0) &amp;#123;
            $this-&gt;delay_mark[$this-&gt;lchild($root)] += $this-&gt;delay_mark[$root];
            $this-&gt;delay_mark[$this-&gt;rchild($root)] += $this-&gt;delay_mark[$root];
            // change value
            $this-&gt;segTree[$this-&gt;lchild($root)] += $this-&gt;delay_mark[$root];
            $this-&gt;segTree[$this-&gt;rchild($root)] += $this-&gt;delay_mark[$root];
            $this-&gt;delay_mark[$root] = 0;
        &amp;#125;
    &amp;#125;

    // 区间更新
    public function updateRange($root, $nbegin, $nend, $ubegin, $uend, $val) &amp;#123;
        if ($ubegin &gt; $nend || $uend &lt; $nbegin) &amp;#123;
            return;
        &amp;#125;
        if ($ubegin &lt;= $nbegin &amp;&amp; $uend &gt;= $nend) &amp;#123;
            $this-&gt;segTree[$root] += $val;
            $this-&gt;delay_mark[$root] += $val;
            return;
        &amp;#125;
        $this-&gt;pushDown($root);
        $mid = $this-&gt;middate($nbegin, $nend);
        $this-&gt;updateRange($this-&gt;lchild($root), $nbegin, $mid, $ubegin, $uend, $val);
        $this-&gt;updateRange($this-&gt;rchild($root), $this-&gt;nextnday($mid), $nend, $ubegin, $uend, $val);
        $this-&gt;pushUp($root);
    &amp;#125;

    // 输出值
    public function dumpTree($root, $begin, $end) &amp;#123;
        echo &quot;&amp;#123;$begin&amp;#125; ~ &amp;#123;$end&amp;#125; : root: &amp;#123;$root&amp;#125;, val: &amp;#123;$this-&gt;segTree[$root]&amp;#125; &quot;;
        echo &quot;\r\n&quot;;
        if (strtotime($begin) == strtotime($end)) &amp;#123;
            return;
        &amp;#125; else &amp;#123;
            $mid = $this-&gt;middate($begin, $end);
            $this-&gt;dumpTree($this-&gt;lchild($root), $begin, $mid);
            $this-&gt;dumpTree($this-&gt;rchild($root), $this-&gt;nextnday($mid), $end);
        &amp;#125;
        return;
    &amp;#125;


&amp;#125;


function test() &amp;#123;
    $dataset = array(
        &#39;2017-01-01&#39; =&gt; 6,
        &#39;2017-01-02&#39; =&gt; 2,
        &#39;2017-01-03&#39; =&gt; 5,
        &#39;2017-01-04&#39; =&gt; 8,
        &#39;2017-01-05&#39; =&gt; 12,
        &#39;2017-01-06&#39; =&gt; 9,
        &#39;2017-01-07&#39; =&gt; 10,
        &#39;2017-01-08&#39; =&gt; 11
    );
    $tree = new TSSegTree(&#39;2017-01-01&#39;, &#39;2017-01-08&#39;, $dataset);
    $tree-&gt;updateNode(0, &#39;2017-01-01&#39;, &#39;2017-01-08&#39;, &#39;2017-01-04&#39;, 2);
    $result = $tree-&gt;query(0, &#39;2017-01-01&#39;, &#39;2017-01-08&#39;, &#39;2017-01-03&#39;, &#39;2017-01-06&#39;);
    echo $result;

    $tree-&gt;dumpTree(0, &#39;2017-01-01&#39;, &#39;2017-01-08&#39;);
    $tree-&gt;updateRange(0, &#39;2017-01-01&#39;, &#39;2017-01-08&#39;, &#39;2017-01-03&#39;, &#39;2017-01-06&#39;, -1);
    $result = $tree-&gt;query(0, &#39;2017-01-01&#39;, &#39;2017-01-08&#39;, &#39;2017-01-03&#39;, &#39;2017-01-06&#39;);
    echo $result;
    echo &quot;\r\n&quot;;
    $tree-&gt;dumpTree(0, &#39;2017-01-01&#39;, &#39;2017-01-08&#39;);

&amp;#125;
test();

?&gt;

</code></pre>

    </div>
</article>
        </main>
        <aside class="aside">
            <div class="close"></div>
            <section class="aside-section">
                
    <h1>Categories</h1>

    <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Computer-Science/">Computer Science</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/diary/">diary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/financial-mathematics/">financial mathematics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">programming</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading-notes/">reading notes</a></li></ul>

            </section>
            <section class="aside-section">
                
    <h1>Archives</h1>

    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/">2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/">2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/">2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/">2012</a></li></ul>


            </section>
            <section class="aside-section tag">
                
    <h1>Tags</h1>

    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2017/" rel="tag">2017</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/2018/" rel="tag">2018</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/2019/" rel="tag">2019</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSAPP/" rel="tag">CSAPP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O/" rel="tag">I/O</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/autumn/" rel="tag">autumn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/" rel="tag">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpp/" rel="tag">cpp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discipline/" rel="tag">discipline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fork/" rel="tag">fork</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/freedom/" rel="tag">freedom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/" rel="tag">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interest/" rel="tag">interest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lambda/" rel="tag">lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/manjianghong/" rel="tag">manjianghong</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory/" rel="tag">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/model/" rel="tag">model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/moon/" rel="tag">moon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/night/" rel="tag">night</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plot/" rel="tag">plot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pointer/" rel="tag">pointer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/radio/" rel="tag">radio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/recursive/" rel="tag">recursive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/segment-tree/" rel="tag">segment tree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shanghai/" rel="tag">shanghai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort/" rel="tag">sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/summer/" rel="tag">summer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tail-call/" rel="tag">tail call</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unix/" rel="tag">unix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/young/" rel="tag">young</a></li></ul>

            </section>
        </aside>
    </div>
</body>

</html>